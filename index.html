<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>岁酱播放器</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#7c3aed', // 主色调：深紫色
            secondary: '#ec4899', // 辅助色：粉色
            accent: '#4f46e5', // 强调色：靛蓝色
            dark: '#0f172a', // 深色背景
            'dark-light': '#1e293b', // 稍浅的深色，用于卡片
            light: '#f8fafc',
            'gray-custom': '#64748b' // 自定义灰色
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 6s ease-in-out infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            glow: {
              '0%': { boxShadow: '0 0 5px rgba(124, 58, 237, 0.5)' },
              '100%': { boxShadow: '0 0 20px rgba(124, 58, 237, 0.8)' },
            }
          }
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      /* 进度条样式 */
      .progress-container {
        @apply relative h-2 w-full rounded-full overflow-hidden bg-gray-700/50 transition-all duration-300 hover:bg-gray-700/80;
      }
      .progress-fill {
        @apply absolute top-0 left-0 h-full bg-gradient-to-r from-primary to-accent transition-all duration-300 ease-out;
      }
      .progress-thumb {
        @apply absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-white shadow-lg border-2 border-primary cursor-pointer transform hover:scale-125 hover:shadow-primary/30 transition-all duration-200;
        box-shadow: 0 0 8px rgba(124, 58, 237, 0.4);
      }
      .progress-thumb:hover {
        box-shadow: 0 0 12px rgba(124, 58, 237, 0.6);
      }
      .progress-thumb:active {
        box-shadow: 0 0 15px rgba(124, 58, 237, 0.8);
      }
      .player-shadow {
        @apply shadow-lg shadow-primary/10 hover:shadow-xl hover:shadow-primary/20 transition-all duration-500;
      }
      .btn-hover {
        @apply hover:scale-110 transition-transform duration-200;
      }
      .album-spin {
        animation: spin 20s linear infinite;
      }
      .lyric-gradient {
        background: linear-gradient(to bottom, rgba(15, 23, 42, 0) 0%, rgba(15, 23, 42, 0.8) 20%, rgba(15, 23, 42, 0.8) 80%, rgba(15, 23, 42, 0) 100%);
      }
      .lyric-active {
        @apply text-primary font-semibold transition-all duration-300;
        text-shadow: 0 0 10px rgba(124, 58, 237, 0.6);
        transform: scale(1.05);
        position: relative;
      }
      .lyric-active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(to right, transparent, #7c3aed, transparent);
        transform: scaleX(0.8);
      }
      .lyric-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      .lyric-fade-out {
        animation: fadeOut 0.5s ease-out forwards;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0.6; transform: translateY(-5px); }
      }
      .gradient-border {
        position: relative;
        border-radius: 1.5rem;
        z-index: 0;
      }
      .gradient-border::before {
        content: "";
        position: absolute;
        inset: -2px;
        z-index: -1;
        border-radius: 1.6rem;
        background: linear-gradient(135deg, #7c3aed, #ec4899, #4f46e5);
        opacity: 0.5;
        transition: opacity 0.3s ease, transform 0.5s ease;
        transform: scale(1);
      }
      .gradient-border:hover::before {
        opacity: 0.8;
        transform: scale(1.02);
      }
      .glass-effect {
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        background: rgba(30, 41, 59, 0.6);
      }
      /* 点击波纹效果 */
      .ripple {
        position: relative;
        overflow: hidden;
      }
      .ripple:after {
        content: "";
        display: block;
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
        background-repeat: no-repeat;
        background-position: 50%;
        transform: scale(10, 10);
        opacity: 0;
        transition: transform .5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.8s;
      }
      .ripple:active:after {
        transform: scale(0, 0);
        opacity: .3;
        transition: 0s;
      }
      /* 列表项增强效果 */
      .playlist-item {
        @apply flex items-center p-2 rounded-lg hover:bg-primary/10 transition-all duration-300 cursor-pointer;
        position: relative;
        overflow: hidden;
      }
      .playlist-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: linear-gradient(to bottom, #7c3aed, #ec4899);
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .playlist-item:hover::before {
        transform: translateX(0);
      }
      .playlist-item-active {
        @apply bg-primary/20 border border-primary/30;
      }
      .playlist-item-active::before {
        transform: translateX(0);
      }
      /* 按钮点击效果 */
      .btn-click {
        @apply transform active:scale-95 transition-transform duration-150;
      }
      /* 粒子容器 */
      .particles-container {
        position: fixed;
        pointer-events: none;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
      }
      .particle {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
      }
      /* 背景装饰元素 */
      .bg-decoration {
        position: fixed;
        border-radius: 50%;
        filter: blur(120px);
        opacity: 0.12;
        z-index: -1;
      }
      /* 导入提示动画 */
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      .import-pulse {
        animation: pulse 2s infinite;
      }
      /* 自定义滚动条 */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(124, 58, 237, 0.3);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(124, 58, 237, 0.5);
      }
      /* 音频可视化样式 */
      .audio-visualizer {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 2px;
        height: 40px;
        width: 100%;
        margin: 10px 0;
      }
      .visualizer-bar {
        width: 4px;
        background: linear-gradient(to top, #7c3aed, #ec4899);
        border-radius: 2px;
        transition: height 0.1s ease;
      }
      /* 加载动画 */
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(124, 58, 237, 0.2);
        border-radius: 50%;
        border-top-color: #7c3aed;
        animation: spin 1s ease-in-out infinite;
      }
      /* 主题切换样式 */
      :root.light-theme {
        --bg-primary: #f8fafc;
        --bg-secondary: #e2e8f0;
        --text-primary: #0f172a;
        --text-secondary: #334155;
      }
      :root.dark-theme {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-dark via-slate-900 to-slate-800 min-h-screen font-inter text-light p-4 transition-colors duration-300 overflow-x-hidden">
  <!-- 主题切换按钮 -->
  <div class="absolute top-4 right-4 z-20">
    <button id="themeToggle" class="p-2 rounded-full bg-dark-light hover:bg-primary/20 transition-colors ripple btn-click particle-trigger">
      <i class="fa fa-moon-o text-gray-400"></i>
    </button>
  </div>
  
  <!-- 背景装饰元素，增强层次感 -->
  <div class="bg-decoration bg-primary w-[600px] h-[600px] top-[-300px] left-[-100px] animate-float"></div>
  <div class="bg-decoration bg-secondary w-[500px] h-[500px] bottom-[-200px] right-[-100px] animate-float" style="animation-delay: 1s;"></div>
  <div class="bg-decoration bg-accent w-[400px] h-[400px] top-[30%] right-[20%] animate-float" style="animation-delay: 2s;"></div>
  
  <!-- 网格背景纹理 -->
  <div class="fixed inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiMxZTI5M2IiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTYwIDBoLTYwdjYwaDYwdj0weiIvPjwvZz48L2c+PC9zdmc+')] opacity-20 z-0"></div>
  
  <!-- 粒子效果容器 -->
  <div class="particles-container" id="particlesContainer"></div>
  
  <!-- 主容器：居中布局 -->
  <div class="max-w-6xl mx-auto w-full flex flex-col items-center relative z-10">
    <!-- 播放器标题 -->
    <div class="mb-6 text-center">
      <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary via-secondary to-accent tracking-wide">
        岁酱播放器
      </h1>
      <p class="text-gray-400 mt-1 text-sm">享受音乐的每一刻</p>
    </div>
    
    <!-- 导入音乐按钮：居中显示 -->
    <div class="mb-6 w-full max-w-md text-center">
      <label for="audioImport" class="bg-gradient-to-r from-primary to-accent hover:from-primary/90 hover:to-accent/90 text-white py-2.5 px-6 rounded-full inline-flex items-center cursor-pointer transition-all btn-hover shadow-lg shadow-primary/20 ripple btn-click particle-trigger import-pulse">
        <i class="fa fa-upload mr-2"></i>导入本地音乐
        <input type="file" id="audioImport" accept="audio/*" multiple="" class="hidden">
      </label>
      <label for="lyricImport" class="bg-gradient-to-r from-secondary to-accent hover:from-secondary/90 hover:to-accent/90 text-white py-2.5 px-6 rounded-full inline-flex items-center cursor-pointer transition-all btn-hover ml-3 shadow-lg shadow-secondary/20 ripple btn-click particle-trigger opacity-50 cursor-not-allowed" id="lyricImportLabel" disabled>
        <i class="fa fa-file-text-o mr-2"></i>导入歌词
        <input type="file" id="lyricImport" accept=".lrc,.txt" class="hidden">
      </label>
    </div>
    
    <!-- 导入状态提示 -->
    <div id="importStatus" class="mb-4 hidden w-full max-w-md mx-auto p-3 rounded-lg bg-dark-light/80 text-center border border-primary/20">
      <div class="flex items-center justify-center">
        <i class="fa fa-circle-o-notch fa-spin mr-2 text-primary"></i>
        <span id="importMessage">正在处理音频文件...</span>
      </div>
    </div>
    
    <!-- 播放器整体居中 -->
    <div class="w-full">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- 左侧：播放器主体 -->
        <div class="lg:w-2/3">
          <!-- 音乐播放器容器 -->
          <div class="gradient-border glass-effect rounded-2xl p-6 player-shadow border border-white/10 h-full transition-all duration-500 hover:translate-y-[-5px]">
            <!-- 专辑封面和歌曲信息（横屏时并排显示） -->
            <div class="flex flex-col sm:flex-row gap-6 mb-6">
              <!-- 专辑封面 -->
              <div class="relative rounded-xl overflow-hidden group sm:w-1/3 md:w-1/4 shadow-xl border-2 border-white/10 cursor-pointer ripple btn-click particle-trigger mx-auto sm:mx-0 animate-float">
                <div class="absolute inset-0 bg-gradient-to-r from-primary/20 to-accent/20 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                <img id="albumCover" src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/code_assistant/82e83a73cbda471383dc50b3e2c2b278~tplv-a9rns2rl98-image.image?rk3s=8e244e95&amp;rrcfp=e75484ac&amp;x-expires=1754122500&amp;x-signature=xXeX8%2FyLZ6FStLdcut8pWK7B3qQ%3D" alt="默认专辑封面" class="w-full aspect-square object-cover transition-transform duration-700 group-hover:scale-110">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                  <div class="w-16 h-16 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center animate-glow">
                    <i class="fa fa-play text-white text-xl"></i>
                  </div>
                </div>
              </div>
              
              <!-- 歌曲信息：居中对齐 -->
              <div class="flex-1 flex flex-col justify-center items-center sm:items-start text-center sm:text-left">
                <h2 class="text-[clamp(1.2rem,3vw,1.8rem)] font-bold truncate text-white" id="songTitle">你要导入歌曲哦~</h2>
                <p class="text-gray-300 mt-2 text-sm sm:text-base" id="songArtist">点击上方按钮开始导入本地音乐</p>
                
                <!-- 音频可视化 -->
                <div class="audio-visualizer mt-4 w-full max-w-xs"></div>
                
                <!-- 播放模式显示（横屏时位置调整） -->
                <div class="mt-3 text-sm text-gray-400 flex items-center">
                  <i class="fa fa-repeat mr-2" id="modeIcon"></i>
                  <span id="modeText">顺序播放</span>
                </div>
              </div>
            </div>
            
            <!-- 歌词显示区域 -->
            <div class="relative rounded-xl overflow-hidden mb-6 h-72 bg-gradient-to-b from-dark/70 via-dark-light/80 to-dark/70 border border-white/10 shadow-inner transition-all duration-300 hover:border-primary/20">
              <!-- 上下渐变遮罩 -->
              <div class="absolute top-0 left-0 right-0 h-20 lyric-gradient pointer-events-none"></div>
              <div class="absolute bottom-0 left-0 right-0 h-20 lyric-gradient pointer-events-none transform rotate-180"></div>
              
              <div class="absolute top-2 left-2 text-xs text-gray-500 z-10">
                <i class="fa fa-music mr-1"></i>歌词
              </div>
              
              <!-- 歌词容器 -->
              <div id="lyricContainer" class="flex flex-col items-center h-full text-center overflow-y-auto py-6 px-4 text-base">
                <!-- 歌词将在这里动态加载 -->
                <div class="text-gray-500 space-y-2">
                  <i class="fa fa-file-text-o text-2xl mb-2 block text-gray-600"></i>
                  <p>暂无歌词</p>
                  <p class="text-xs mt-1 text-gray-600">请先导入歌曲，再为歌曲导入LRC歌词文件</p>
                </div>
              </div>
            </div>
            
            <!-- 进度条 -->
            <div class="mb-6 px-1">
              <div class="flex justify-between text-xs text-gray-400 mb-1">
                <span id="currentTime">00:00</span>
                <span id="totalTime">00:00</span>
              </div>
              <div class="progress-container cursor-pointer particle-trigger" id="progressBarContainer">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                <div class="progress-thumb" id="progressThumb" style="left: 0%"></div>
              </div>
              <!-- 隐藏原生input，用于实际值的存储和操作 -->
              <input type="range" id="progressInput" min="0" max="100" value="0" class="hidden">
            </div>
            
            <!-- 音量控制 -->
            <div class="mb-6 px-2">
              <div class="flex items-center space-x-2">
                <i class="fa fa-volume-up text-gray-400 w-5 cursor-pointer particle-trigger hover:text-primary transition-colors" id="volumeIcon"></i>
                <div class="progress-container cursor-pointer particle-trigger flex-1" id="volumeBarContainer">
                  <div class="progress-fill" id="volumeFill" style="width: 80%"></div>
                  <div class="progress-thumb" id="volumeThumb" style="left: 80%"></div>
                </div>
                <!-- 隐藏原生input，用于实际值的存储和操作 -->
                <input type="range" id="volumeInput" min="0" max="100" value="80" class="hidden">
              </div>
            </div>
            
            <!-- 控制按钮：居中对齐 -->
            <div class="flex items-center justify-between mt-4 max-w-md mx-auto">
              <!-- 播放模式 -->
              <button id="modeButton" class="text-gray-400 hover:text-accent btn-hover ripple btn-click particle-trigger" disabled="">
                <i class="fa fa-list text-xl" aria-label="顺序播放"></i>
              </button>
              
              <!-- 上一首 -->
              <button id="prevButton" class="text-gray-300 hover:text-primary btn-hover ripple btn-click particle-trigger" disabled="">
                <i class="fa fa-step-backward text-2xl"></i>
              </button>
              
              <!-- 播放/暂停 -->
              <button id="playPauseButton" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white btn-hover shadow-lg shadow-primary/30 ripple btn-click particle-trigger animate-glow" disabled="">
                <i class="fa fa-play text-2xl sm:text-3xl"></i>
              </button>
              
              <!-- 下一首 -->
              <button id="nextButton" class="text-gray-300 hover:text-primary btn-hover ripple btn-click particle-trigger" disabled="">
                <i class="fa fa-step-forward text-2xl"></i>
              </button>
              
              <!-- 静音按钮 -->
              <button id="muteButton" class="text-gray-400 hover:text-secondary btn-hover ripple btn-click particle-trigger" disabled="">
                <i class="fa fa-volume-up text-xl"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- 右侧：播放列表 -->
        <div class="lg:w-1/3">
          <div class="glass-effect rounded-xl p-4 player-shadow border border-white/10 h-full transition-all duration-500 hover:translate-y-[-5px] hover:border-primary/20">
            <h3 class="text-sm font-semibold mb-3 text-gray-200 flex items-center justify-center sm:justify-start">
              <i class="fa fa-list-ul mr-2 text-accent"></i>播放列表
              <span id="localFilesIndicator" class="ml-2 text-xs bg-secondary/20 text-secondary px-2 py-0.5 rounded-full hidden">
                包含本地文件
              </span>
            </h3>
            <ul id="playlist" class="space-y-2 max-h-[320px] sm:max-h-[400px] overflow-y-auto pr-2">
              <li class="flex items-center justify-center p-8 text-gray-500">
                <div class="text-center">
                  <i class="fa fa-music text-3xl mb-3 text-primary/50"></i>
                  <p>你要导入歌曲哦~</p>
                  <p class="text-xs mt-1">请点击上方按钮导入本地音乐</p>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- 底部信息 -->
      <div class="mt-8 text-center text-gray-500 text-xs">
        <p>岁酱播放器 &copy; 2025 | 享受高品质音乐体验</p>
      </div>
    </div>
  </div>
  
  <!-- 音频元素 -->
  <audio id="audioPlayer" preload="metadata">
   您的浏览器不支持音频播放
  </audio>

  <script>
    // 粒子效果实现
    const particlesContainer = document.getElementById('particlesContainer');
    
    // 生成随机颜色，基于主题色
    function getRandomColor() {
      const colors = [
        '#7c3aed', // primary
        '#ec4899', // secondary
        '#4f46e5', // accent
        '#a78bfa', // light accent
        '#f472b6', // light secondary
        '#818cf8', // light primary
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }
    
    // 创建粒子
    function createParticles(x, y, count = 8) {
      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        
        // 随机大小
        const size = Math.random() * 8 + 2;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        // 随机颜色
        particle.style.backgroundColor = getRandomColor();
        
        // 位置
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        
        // 随机动画
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * 40 + 20;
        const duration = Math.random() * 800 + 600;
        
        // 添加到容器
        particlesContainer.appendChild(particle);
        
        // 动画
        setTimeout(() => {
          const endX = x + Math.cos(angle) * distance;
          const endY = y + Math.sin(angle) * distance;
          
          particle.style.transition = `all ${duration}ms ease-out`;
          particle.style.transform = `translate(${endX - x}px, ${endY - y}px)`;
          particle.style.opacity = '0';
          
          // 动画结束后移除
          setTimeout(() => {
            if (particlesContainer.contains(particle)) {
              particlesContainer.removeChild(particle);
            }
          }, duration);
        }, 10);
      }
    }
    
    // 为所有带particle-trigger类的元素添加粒子效果
    document.querySelectorAll('.particle-trigger').forEach(element => {
      element.addEventListener('click', (e) => {
        // 阻止事件冒泡
        e.stopPropagation();
        
        // 获取点击位置（相对于视口）
        const rect = element.getBoundingClientRect();
        const x = e.clientX;
        const y = e.clientY;
        
        // 创建粒子
        createParticles(x, y);
      });
    });
    
    // 播放列表项点击添加粒子效果
    playlist.addEventListener('click', (e) => {
      const listItem = e.target.closest('li.playlist-item');
      if (listItem) {
        const rect = listItem.getBoundingClientRect();
        const x = e.clientX;
        const y = e.clientY;
        createParticles(x, y, 5);
      }
    });
    
    // 背景装饰元素动画
    function animateBackgroundDecorations() {
      const decorations = document.querySelectorAll('.bg-decoration');
      decorations.forEach((decor, index) => {
        // 为每个装饰元素设置不同的动画参数
        const speed = 30000 + index * 10000; // 30-50秒一圈
        const startPos = Math.random() * 360;
        
        // 旋转动画
        decor.style.transition = `transform ${speed}ms linear infinite`;
        decor.style.transform = `rotate(${startPos}deg)`;
        
        // 随时间微调位置
        setInterval(() => {
          const x = (Math.sin(Date.now() * 0.0001 + index) * 20) + 'px';
          const y = (Math.cos(Date.now() * 0.0001 + index) * 20) + 'px';
          decor.style.transform = `translate(${x}, ${y}) rotate(${startPos + (Date.now() * 0.0001 * 360 / (speed/1000))}deg)`;
        }, 1000);
      });
    }
    
    // 音频可视化核心代码
    function initVisualizer() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createMediaElementSource(audioPlayer);
      const analyser = audioContext.createAnalyser();
      
      source.connect(analyser);
      analyser.connect(audioContext.destination);
      
      analyser.fftSize = 32;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      const visualizer = document.querySelector('.audio-visualizer');
      
      // 清空现有柱形
      visualizer.innerHTML = '';
      
      // 创建频谱柱
      for (let i = 0; i < bufferLength; i++) {
        const bar = document.createElement('div');
        bar.className = 'visualizer-bar';
        bar.style.height = '2px';
        visualizer.appendChild(bar);
      }
      
      const bars = visualizer.querySelectorAll('.visualizer-bar');
      
      function updateVisualizer() {
        if (audioPlayer.paused) {
          // 音频暂停时，让频谱柱逐渐降低
          bars.forEach(bar => {
            const currentHeight = parseInt(bar.style.height);
            if (currentHeight > 2) {
              bar.style.height = `${currentHeight - 2}px`;
            }
          });
          requestAnimationFrame(updateVisualizer);
          return;
        }
        
        analyser.getByteFrequencyData(dataArray);
        
        bars.forEach((bar, i) => {
          // 限制最大高度并增加一些视觉效果
          const height = Math.min((dataArray[i] / 255) * 40, 40);
          bar.style.height = `${height}px`;
          
          // 根据高度调整透明度，增加视觉层次感
          bar.style.opacity = `${0.5 + (height / 40) * 0.5}`;
        });
        
        requestAnimationFrame(updateVisualizer);
      }
      
      // 启动可视化
      updateVisualizer();
      
      // 播放时确保音频上下文已恢复
      audioPlayer.addEventListener('play', () => {
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
      });
    }
    
    // 音乐播放器核心功能
    // 获取DOM元素
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseButton = document.getElementById('playPauseButton');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const progressInput = document.getElementById('progressInput');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressFill = document.getElementById('progressFill');
    const progressThumb = document.getElementById('progressThumb');
    const currentTimeDisplay = document.getElementById('currentTime');
    const totalTimeDisplay = document.getElementById('totalTime');
    const modeButton = document.getElementById('modeButton');
    const modeText = document.getElementById('modeText');
    const modeIcon = document.getElementById('modeIcon');
    const muteButton = document.getElementById('muteButton');
    const volumeInput = document.getElementById('volumeInput');
    const volumeBarContainer = document.getElementById('volumeBarContainer');
    const volumeFill = document.getElementById('volumeFill');
    const volumeThumb = document.getElementById('volumeThumb');
    const volumeIcon = document.getElementById('volumeIcon');
    const songTitle = document.getElementById('songTitle');
    const songArtist = document.getElementById('songArtist');
    const albumCover = document.getElementById('albumCover');
    const audioImport = document.getElementById('audioImport');
    const lyricImport = document.getElementById('lyricImport');
    const lyricContainer = document.getElementById('lyricContainer');
    const localFilesIndicator = document.getElementById('localFilesIndicator');
    const lyricImportLabel = document.getElementById('lyricImportLabel');
    const importStatus = document.getElementById('importStatus');
    const importMessage = document.getElementById('importMessage');
    const playlist = document.getElementById('playlist');
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;
    
    // 播放模式: 0-顺序播放, 1-单曲循环, 2-随机播放
    let playMode = 0;
    // 当前播放索引
    let currentIndex = -1;
    // 是否正在拖动进度条
    let isDraggingProgress = false;
    let isDraggingVolume = false;
    // 是否有本地文件
    let hasLocalFiles = false;
    // 保存原始音量，用于静音时恢复
    let originalVolume = 0.8;
    // 歌词数据
    let lyrics = [];
    // 当前歌词索引
    let currentLyricIndex = -1;
    // 歌词滚动动画是否启用
    let lyricAnimationEnabled = true;
    // 歌词行高
    const lyricLineHeight = 36;
    
    // 歌曲列表数据 - 仅包含本地导入的歌曲
    const songs = [];
    
    // 格式化时间（秒 -> mm:ss）
    function formatTime(seconds) {
      if (isNaN(seconds)) return '00:00';
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // 更新进度条和歌词
    function updateProgress() {
      if (!isDraggingProgress && !isNaN(audioPlayer.duration)) {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressInput.value = progress;
        progressFill.style.width = `${progress}%`;
        progressThumb.style.left = `${progress}%`;
        currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
        
        // 更新歌词显示
        updateLyrics(audioPlayer.currentTime);
      }
    }
    
    // 更新总时间
    function updateTotalTime() {
      if (!isNaN(audioPlayer.duration)) {
        totalTimeDisplay.textContent = formatTime(audioPlayer.duration);
      }
    }
    
    // 切换播放/暂停
    function togglePlayPause() {
      if (audioPlayer.paused) {
        audioPlayer.play();
        playPauseButton.innerHTML = '<i class="fa fa-pause text-2xl sm:text-3xl"></i>';
        albumCover.classList.add('album-spin');
      } else {
        audioPlayer.pause();
        playPauseButton.innerHTML = '<i class="fa fa-play text-2xl sm:text-3xl"></i>';
        albumCover.classList.remove('album-spin');
      }
    }
    
    // 切换播放模式
    function togglePlayMode() {
      playMode = (playMode + 1) % 3;
      updateModeUI();
    }
    
    // 更新播放模式UI
    function updateModeUI() {
      switch(playMode) {
        case 0: // 顺序播放
          modeButton.innerHTML = '<i class="fa fa-list text-xl"></i>';
          modeIcon.className = 'fa fa-list mr-2';
          modeButton.setAttribute('aria-label', '顺序播放');
          modeText.textContent = '顺序播放';
          break;
        case 1: // 单曲循环
          modeButton.innerHTML = '<i class="fa fa-repeat text-xl"></i>';
          modeIcon.className = 'fa fa-repeat mr-2';
          modeButton.setAttribute('aria-label', '单曲循环');
          modeText.textContent = '单曲循环';
          break;
        case 2: // 随机播放
          modeButton.innerHTML = '<i class="fa fa-random text-xl"></i>';
          modeIcon.className = 'fa fa-random mr-2';
          modeButton.setAttribute('aria-label', '随机播放');
          modeText.textContent = '随机播放';
          break;
      }
    }
    
    // 播放指定索引的歌曲
    function playSong(index) {
      if (index < 0 || index >= songs.length) return;
      
      currentIndex = index;
      const song = songs[index];
      
      // 清除当前歌词
      clearLyrics();
      
      // 更新歌曲信息
      songTitle.textContent = song.title;
      songArtist.textContent = song.artist || '未知艺术家';
      totalTimeDisplay.textContent = song.duration || "00:00";
      
      // 更新专辑封面
      albumCover.src = song.cover;
      albumCover.alt = `${song.title} 专辑封面`;
      
      // 更新音频源并播放
      audioPlayer.src = song.src;
      audioPlayer.load();
      audioPlayer.play().then(() => {
        playPauseButton.innerHTML = '<i class="fa fa-pause text-2xl sm:text-3xl"></i>';
        albumCover.classList.add('album-spin');
        enableControls();
        
        // 启用歌词导入按钮
        enableLyricImport();
        
        // 如果有保存的歌词，加载它
        if (song.lyrics) {
          loadLyrics(song.lyrics);
        }
      }).catch(error => {
        console.error("播放失败:", error);
        showImportStatus(`播放失败: ${error.message}`, false);
      });
      
      // 更新播放列表选中状态
      updatePlaylistSelection();
    }
    
    // 更新播放列表选中状态
    function updatePlaylistSelection() {
      const items = playlist.querySelectorAll('li');
      items.forEach((item, index) => {
        // 清除所有列表项的选中状态
        item.classList.remove('playlist-item-active');
        
        // 设置当前播放项的选中状态
        if (index === currentIndex) {
          item.classList.add('playlist-item-active');
        }
      });
    }
    
    // 下一首
    function nextSong() {
      if (songs.length === 0) return;
      
      let index;
      if (playMode === 2) { // 随机播放
        if (songs.length <= 1) {
          index = 0;
        } else {
          // 确保随机索引与当前索引不同
          do {
            index = Math.floor(Math.random() * songs.length);
          } while (index === currentIndex);
        }
      } else { // 顺序播放或单曲循环
        index = (currentIndex + 1) % songs.length;
      }
      
      playSong(index);
    }
    
    // 上一首
    function prevSong() {
      if (songs.length === 0) return;
      
      let index;
      if (playMode === 2) { // 随机播放
        if (songs.length <= 1) {
          index = 0;
        } else {
          // 确保随机索引与当前索引不同
          do {
            index = Math.floor(Math.random() * songs.length);
          } while (index === currentIndex);
        }
      } else { // 顺序播放或单曲循环
        index = (currentIndex - 1 + songs.length) % songs.length;
      }
      
      playSong(index);
    }
    
    // 拖动进度条时更新播放位置
    function updateProgressFromInput(value) {
      if (!isNaN(audioPlayer.duration)) {
        const seekTime = (value / 100) * audioPlayer.duration;
        audioPlayer.currentTime = seekTime;
        currentTimeDisplay.textContent = formatTime(seekTime);
        
        // 拖动时禁用歌词动画，提升性能
        lyricAnimationEnabled = false;
        // 同步更新歌词
        updateLyrics(seekTime);
        
        // 拖动结束后重新启用动画
        setTimeout(() => {
          lyricAnimationEnabled = true;
        }, 500);
      }
    }
    
    // 处理进度条点击和拖动
    function handleProgressInteraction(e) {
      const rect = progressBarContainer.getBoundingClientRect();
      const pos = (e.clientX - rect.left) / rect.width;
      const value = Math.max(0, Math.min(100, pos * 100));
      
      progressInput.value = value;
      progressFill.style.width = `${value}%`;
      progressThumb.style.left = `${value}%`;
      
      updateProgressFromInput(value);
    }
    
    // 处理音量条点击和拖动
    function handleVolumeInteraction(e) {
      const rect = volumeBarContainer.getBoundingClientRect();
      const pos = (e.clientX - rect.left) / rect.width;
      const value = Math.max(0, Math.min(100, pos * 100));
      
      volumeInput.value = value;
      volumeFill.style.width = `${value}%`;
      volumeThumb.style.left = `${value}%`;
      
      adjustVolume(value);
    }
    
    // 处理歌曲结束
    function handleEnded() {
      if (playMode === 1) { // 单曲循环
        audioPlayer.currentTime = 0;
        audioPlayer.play();
      } else { // 顺序播放或随机播放
        nextSong();
      }
    }
    
    // 调节音量
    function adjustVolume(value) {
      const volume = value / 100;
      audioPlayer.volume = volume;
      originalVolume = volume; // 保存当前音量，用于静音后恢复
      
      // 更新音量图标
      updateVolumeIcon();
    }
    
    // 更新音量图标
    function updateVolumeIcon() {
      const volume = volumeInput.value / 100;
      if (audioPlayer.muted || volume === 0) {
        muteButton.innerHTML = '<i class="fa fa-volume-off text-xl"></i>';
        volumeIcon.className = 'fa fa-volume-off text-gray-400 w-5 cursor-pointer hover:text-primary transition-colors';
      } else if (volume < 0.5) {
        muteButton.innerHTML = '<i class="fa fa-volume-down text-xl"></i>';
        volumeIcon.className = 'fa fa-volume-down text-gray-400 w-5 cursor-pointer hover:text-primary transition-colors';
      } else {
        muteButton.innerHTML = '<i class="fa fa-volume-up text-xl"></i>';
        volumeIcon.className = 'fa fa-volume-up text-gray-400 w-5 cursor-pointer hover:text-primary transition-colors';
      }
    }
    
    // 切换静音状态
    function toggleMute() {
      if (audioPlayer.muted) {
        // 取消静音，恢复之前的音量
        audioPlayer.muted = false;
        volumeInput.value = originalVolume * 100;
        volumeFill.style.width = `${originalVolume * 100}%`;
        volumeThumb.style.left = `${originalVolume * 100}%`;
      } else {
        // 静音，保存当前音量
        audioPlayer.muted = true;
        originalVolume = audioPlayer.volume;
      }
      
      // 更新音量图标
      updateVolumeIcon();
    }
    
    // 解析LRC歌词
    function parseLyrics(lrcText) {
      const lyricLines = lrcText.split('\n');
      const parsedLyrics = [];
      
      // 支持多种时间格式：[mm:ss.xx]、[mm:ss]、[mm:ss:xxx]
      const timeRegex = /\[(\d+):(\d+)(:(\d+)|(\.\d+))?\]/;
      
      lyricLines.forEach(line => {
        const match = line.match(timeRegex);
        if (match) {
          const minutes = parseInt(match[1]);
          const seconds = parseInt(match[2]);
          let milliseconds = 0;
          
          // 处理毫秒部分
          if (match[4]) {
            // 格式 [mm:ss:xxx]
            milliseconds = parseInt(match[4]) / 1000;
          } else if (match[5]) {
            // 格式 [mm:ss.xx]
            milliseconds = parseFloat(match[5]);
          }
          
          const time = minutes * 60 + seconds + milliseconds;
          const text = line.replace(timeRegex, '').trim();
          
          if (text) {
            parsedLyrics.push({ time, text });
          }
        }
      });
      
      // 按时间排序并去重
      return parsedLyrics
        .sort((a, b) => a.time - b.time)
        .filter((lyric, index, self) => 
          index === 0 || !(self[index-1].time === lyric.time && self[index-1].text === lyric.text)
        );
    }
    
    // 加载歌词
    function loadLyrics(lrcText) {
      lyrics = parseLyrics(lrcText);
      currentLyricIndex = -1;
      
      // 清空歌词容器
      lyricContainer.innerHTML = '';
      
      if (lyrics.length === 0) {
        lyricContainer.innerHTML = `
          <div class="text-gray-500 space-y-2">
            <i class="fa fa-file-text-o text-2xl mb-2 block text-gray-600"></i>
            <p>无法解析歌词</p>
            <p class="text-xs mt-1 text-gray-600">请确保导入的是有效的LRC歌词文件</p>
          </div>
        `;
        return;
      }
      
      // 创建歌词元素容器
      const lyricsWrapper = document.createElement('div');
      lyricsWrapper.className = 'w-full';
      
      // 创建歌词元素
      lyrics.forEach((lyric, index) => {
        const lyricElement = document.createElement('div');
        lyricElement.className = 'py-2 px-4 text-gray-300 transition-all duration-300 opacity-70 min-h-[36px]';
        lyricElement.textContent = lyric.text;
        lyricElement.dataset.index = index;
        lyricElement.dataset.time = lyric.time;
        lyricsWrapper.appendChild(lyricElement);
      });
      
      lyricContainer.appendChild(lyricsWrapper);
      
      // 同步当前歌词
      updateLyrics(audioPlayer.currentTime);
    }
    
    // 更新歌词显示
    function updateLyrics(currentTime) {
      if (lyrics.length === 0) return;
      
      // 优化歌词查找算法，使用二分查找提高性能
      let newIndex = findCurrentLyricIndex(currentTime);
      
      // 如果歌词索引没变，不需要更新
      if (newIndex === currentLyricIndex) return;
      
      // 移除之前的活跃歌词样式
      if (currentLyricIndex !== -1) {
        const prevElement = lyricContainer.querySelector(`[data-index="${currentLyricIndex}"]`);
        if (prevElement) {
          prevElement.classList.remove('lyric-active');
          if (lyricAnimationEnabled) {
            prevElement.classList.add('lyric-fade-out');
            setTimeout(() => {
              prevElement.classList.remove('lyric-fade-out');
            }, 500);
          }
        }
      }
      
      currentLyricIndex = newIndex;
      
      // 添加新的活跃歌词样式
      if (currentLyricIndex !== -1) {
        const currentElement = lyricContainer.querySelector(`[data-index="${currentLyricIndex}"]`);
        if (currentElement) {
          currentElement.classList.add('lyric-active');
          if (lyricAnimationEnabled) {
            currentElement.classList.add('lyric-fade-in');
            setTimeout(() => {
              currentElement.classList.remove('lyric-fade-in');
            }, 500);
          }
          
          // 滚动到当前歌词，使其居中显示
          const containerHeight = lyricContainer.clientHeight;
          const scrollTop = currentElement.offsetTop - containerHeight / 2 + lyricLineHeight / 2;
          lyricContainer.scrollTo({
            top: scrollTop,
            behavior: lyricAnimationEnabled ? 'smooth' : 'auto'
          });
        }
      }
    }
    
    // 二分查找当前歌词索引
    function findCurrentLyricIndex(currentTime) {
      let low = 0;
      let high = lyrics.length - 1;
      let result = -1;
      
      while (low <= high) {
        const mid = Math.floor((low + high) / 2);
        if (lyrics[mid].time <= currentTime) {
          result = mid;
          low = mid + 1;
        } else {
          high = mid - 1;
        }
      }
      
      // 检查是否超出最后一句歌词
      if (result === lyrics.length - 1 && 
          currentTime > lyrics[result].time + 5) {
        return -1;
      }
      
      return result;
    }
    
    // 清除歌词
    function clearLyrics() {
      lyrics = [];
      currentLyricIndex = -1;
      lyricContainer.innerHTML = `
        <div class="text-gray-500 space-y-2">
          <i class="fa fa-file-text-o text-2xl mb-2 block text-gray-600"></i>
          <p>暂无歌词</p>
          <p class="text-xs mt-1 text-gray-600">请先导入歌曲，再为歌曲导入LRC歌词文件</p>
        </div>
      `;
    }
    
    // 启用控制按钮
    function enableControls() {
      playPauseButton.disabled = false;
      prevButton.disabled = false;
      nextButton.disabled = false;
      modeButton.disabled = false;
      muteButton.disabled = false;
    }
    
    // 禁用控制按钮
    function disableControls() {
      playPauseButton.disabled = true;
      prevButton.disabled = true;
      nextButton.disabled = true;
      modeButton.disabled = true;
      muteButton.disabled = true;
    }
    
    // 启用歌词导入
    function enableLyricImport() {
      lyricImportLabel.disabled = false;
      lyricImportLabel.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    // 禁用歌词导入
    function disableLyricImport() {
      lyricImportLabel.disabled = true;
      lyricImportLabel.classList.add('opacity-50', 'cursor-not-allowed');
    }
    
    // 显示导入状态
    function showImportStatus(message, isLoading = true) {
      importMessage.textContent = message;
      importStatus.classList.remove('hidden');
      
      if (!isLoading) {
        // 非加载状态3秒后隐藏
        setTimeout(() => {
          importStatus.classList.add('hidden');
        }, 3000);
      }
    }
    
    // 隐藏导入状态
    function hideImportStatus() {
      importStatus.classList.add('hidden');
    }
    
    // 解析歌曲元数据
    function parseSongMetadata(file, audioElement) {
      return new Promise((resolve) => {
        const songInfo = {
          title: file.name.replace(/\.[^/.]+$/, ""), // 默认使用文件名作为标题
          artist: "未知艺术家",
          duration: formatTime(audioElement.duration),
          src: URL.createObjectURL(file),
          cover: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/code_assistant/82e83a73cbda471383dc50b3e2c2b278~tplv-a9rns2rl98-image.image?rk3s=8e244e95&amp;rrcfp=e75484ac&amp;x-expires=1754122500&amp;x-signature=xXeX8%2FyLZ6FStLdcut8pWK7B3qQ%3D",
          file: file
        };
        
        // 尝试从ID3标签获取信息
        // 这里简化处理，实际项目中可以使用专门的ID3解析库
        resolve(songInfo);
      });
    }
    
    // 处理音频文件导入
    function handleAudioImport(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      // 显示导入状态
      showImportStatus(`正在处理 ${files.length} 个音频文件...`);
      
      // 清空文件输入，允许重复导入相同文件
      audioImport.value = '';
      
      // 处理每个音频文件
      let newSongsCount = 0;
      
      // 创建临时音频元素用于获取元数据
      const tempAudio = new Audio();
      
      // 递归处理文件
      function processFile(index) {
        if (index >= files.length) {
          // 所有文件处理完毕
          tempAudio.remove();
          
          if (newSongsCount > 0) {
            showImportStatus(`成功导入 ${newSongsCount} 首歌曲`, false);
            
            // 如果是第一次导入歌曲，自动播放第一首
            if (songs.length === newSongsCount) {
              playSong(0);
            }
            
            // 更新播放列表
            updatePlaylist();
            
            // 显示本地文件指示器
            hasLocalFiles = true;
            localFilesIndicator.classList.remove('hidden');
          } else {
            showImportStatus("没有导入新的歌曲", false);
          }
          
          return;
        }
        
        const file = files[index];
        // 检查文件类型
        if (!file.type.startsWith('audio/')) {
          console.warn(`跳过非音频文件: ${file.name}`);
          processFile(index + 1);
          return;
        }
        
        // 检查是否已导入相同文件
        const isDuplicate = songs.some(song => song.file && song.file.name === file.name && song.file.size === file.size);
        if (isDuplicate) {
          console.log(`已跳过重复文件: ${file.name}`);
          processFile(index + 1);
          return;
        }
        
        // 读取文件元数据
        tempAudio.src = URL.createObjectURL(file);
        
        tempAudio.onloadedmetadata = function() {
          // 解析元数据
          parseSongMetadata(file, tempAudio)
            .then(songInfo => {
              // 添加到歌曲列表
              songs.push(songInfo);
              newSongsCount++;
              
              // 处理下一个文件
              processFile(index + 1);
            })
            .catch(error => {
              console.error(`处理文件 ${file.name} 失败:`, error);
              processFile(index + 1);
            });
        };
        
        tempAudio.onerror = function() {
          console.error(`无法加载音频文件: ${file.name}`);
          showImportStatus(`无法加载音频文件: ${file.name}`, false);
          processFile(index + 1);
        };
      }
      
      // 开始处理文件
      processFile(0);
    }
    
    // 处理歌词文件导入
    function handleLyricImport(event) {
      const files = event.target.files;
      if (!files || files.length === 0 || currentIndex === -1) return;
      
      // 清空文件输入
      lyricImport.value = '';
      
      const file = files[0];
      const reader = new FileReader();
      
      showImportStatus(`正在解析歌词文件...`);
      
      reader.onload = function(e) {
        try {
          const lrcText = e.target.result;
          // 保存歌词到当前歌曲
          songs[currentIndex].lyrics = lrcText;
          // 加载歌词
          loadLyrics(lrcText);
          showImportStatus("歌词导入成功", false);
        } catch (error) {
          console.error("解析歌词失败:", error);
          showImportStatus("歌词解析失败，请检查文件格式", false);
        }
      };
      
      reader.onerror = function() {
        console.error("读取歌词文件失败");
        showImportStatus("读取歌词文件失败", false);
      };
      
      reader.readAsText(file, 'utf-8');
    }
    
    // 更新播放列表
    function updatePlaylist() {
      // 清空播放列表
      playlist.innerHTML = '';
      
      if (songs.length === 0) {
        // 没有歌曲时显示提示
        playlist.innerHTML = `
          <li class="flex items-center justify-center p-8 text-gray-500">
            <div class="text-center">
              <i class="fa fa-music text-3xl mb-3 text-primary/50"></i>
              <p>你要导入歌曲哦~</p>
              <p class="text-xs mt-1">请点击上方按钮导入本地音乐</p>
            </div>
          </li>
        `;
        return;
      }
      
      // 添加歌曲到播放列表
      songs.forEach((song, index) => {
        const li = document.createElement('li');
        li.className = `playlist-item ${index === currentIndex ? 'playlist-item-active' : ''}`;
        li.innerHTML = `
          <div class="w-8 text-center text-gray-400">
            ${index === currentIndex ? '<i class="fa fa-play text-primary"></i>' : (index + 1)}
          </div>
          <div class="flex-1 min-w-0">
            <div class="truncate font-medium">${song.title}</div>
            <div class="truncate text-xs text-gray-500">${song.artist}</div>
          </div>
          <div class="text-xs text-gray-500">${song.duration}</div>
        `;
        
        // 添加点击事件
        li.addEventListener('click', () => {
          if (index !== currentIndex) {
            playSong(index);
          } else {
            togglePlayPause();
          }
        });
        
        playlist.appendChild(li);
      });
    }
    
    // 主题切换功能
    function setupThemeToggle() {
      // 初始化主题
      if (localStorage.getItem('theme') === 'light' || 
          (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: light)').matches)) {
        html.classList.add('light-theme');
        html.classList.remove('dark-theme');
        themeToggle.innerHTML = '<i class="fa fa-sun-o text-yellow-400"></i>';
        updateThemeBasedStyles(true);
      } else {
        html.classList.add('dark-theme');
        html.classList.remove('light-theme');
        themeToggle.innerHTML = '<i class="fa fa-moon-o text-gray-400"></i>';
        updateThemeBasedStyles(false);
      }
      
      // 切换主题
      themeToggle.addEventListener('click', () => {
        if (html.classList.contains('dark-theme')) {
          html.classList.remove('dark-theme');
          html.classList.add('light-theme');
          themeToggle.innerHTML = '<i class="fa fa-sun-o text-yellow-400"></i>';
          localStorage.setItem('theme', 'light');
          updateThemeBasedStyles(true);
        } else {
          html.classList.remove('light-theme');
          html.classList.add('dark-theme');
          themeToggle.innerHTML = '<i class="fa fa-moon-o text-gray-400"></i>';
          localStorage.setItem('theme', 'dark');
          updateThemeBasedStyles(false);
        }
      });
    }
    
    // 更新基于主题的样式
    function updateThemeBasedStyles(isLightTheme) {
      const body = document.body;
      const glassElements = document.querySelectorAll('.glass-effect');
      
      if (isLightTheme) {
        body.className = body.className.replace('bg-gradient-to-br from-dark via-slate-900 to-slate-800', 
                                              'bg-gradient-to-br from-gray-50 via-gray-100 to-gray-200');
        glassElements.forEach(el => {
          el.style.background = 'rgba(255, 255, 255, 0.6)';
        });
      } else {
        body.className = body.className.replace('bg-gradient-to-br from-gray-50 via-gray-100 to-gray-200', 
                                              'bg-gradient-to-br from-dark via-slate-900 to-slate-800');
        glassElements.forEach(el => {
          el.style.background = 'rgba(30, 41, 59, 0.6)';
        });
      }
    }
    
    // 事件监听器
    function setupEventListeners() {
      // 音频事件
      audioPlayer.addEventListener('timeupdate', updateProgress);
      audioPlayer.addEventListener('loadedmetadata', updateTotalTime);
      audioPlayer.addEventListener('ended', handleEnded);
      
      // 控制按钮事件
      playPauseButton.addEventListener('click', togglePlayPause);
      prevButton.addEventListener('click', prevSong);
      nextButton.addEventListener('click', nextSong);
      modeButton.addEventListener('click', togglePlayMode);
      muteButton.addEventListener('click', toggleMute);
      volumeIcon.addEventListener('click', toggleMute);
      
      // 进度条事件
      progressBarContainer.addEventListener('click', handleProgressInteraction);
      
      progressThumb.addEventListener('mousedown', () => {
        isDraggingProgress = true;
      });
      
      document.addEventListener('mousemove', (e) => {
        if (isDraggingProgress) {
          handleProgressInteraction(e);
        } else if (isDraggingVolume) {
          handleVolumeInteraction(e);
        }
      });
      
      document.addEventListener('mouseup', () => {
        if (isDraggingProgress) {
          isDraggingProgress = false;
        } else if (isDraggingVolume) {
          isDraggingVolume = false;
        }
      });
      
      // 音量条事件
      volumeBarContainer.addEventListener('click', handleVolumeInteraction);
      
      volumeThumb.addEventListener('mousedown', () => {
        isDraggingVolume = true;
      });
      
      volumeInput.addEventListener('input', (e) => {
        const value = e.target.value;
        volumeFill.style.width = `${value}%`;
        volumeThumb.style.left = `${value}%`;
        adjustVolume(value);
      });
      
      // 文件导入事件
      audioImport.addEventListener('change', handleAudioImport);
      lyricImport.addEventListener('change', handleLyricImport);
      
      // 专辑封面点击事件
      albumCover.parentElement.addEventListener('click', () => {
        if (songs.length > 0) {
          togglePlayPause();
        }
      });
    }
    
    // 初始化
    function init() {
      setupEventListeners();
      updateModeUI();
      animateBackgroundDecorations();
      updatePlaylist();
      disableControls();
      disableLyricImport();
      setupThemeToggle();
      initVisualizer();
    }
    
    // 启动播放器
    init();
  </script>
</body>
</html>
